// Prisma schema for A1 Service Expert booking platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

enum BookingStatus {
  DRAFT
  HELD
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingSource {
  ONLINE
  MANUAL
}

enum DocumentType {
  INVOICE
  QUOTE
}

enum DocumentStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  ISSUED
  PAID
  VOID
}

enum SequenceKey {
  INVOICE
  QUOTE
  BOOKING_REFERENCE
}

enum EngineTierCode {
  SMALL
  MEDIUM
  LARGE
  XLARGE
}

enum ServicePricingMode {
  TIERED
  FIXED
}


model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String
  role          UserRole @default(CUSTOMER)
  emailVerified Boolean  @default(false)
  title                String?
  firstName            String?
  lastName             String?
  companyName          String?
  mobileNumber         String?
  landlineNumber       String?
  addressLine1         String?
  addressLine2         String?
  addressLine3         String?
  city                 String?
  county               String?
  postcode             String?
  marketingOptIn       Boolean  @default(false)
  notes                String?
  registrationIp       String?
  profileUpdatedAt     DateTime?
  lastLoginAt          DateTime?
  deletedAt            DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookings           Booking[]
  verificationTokens EmailVerificationToken[]
  sessions           UserSession[]
  passwordResets     PasswordResetToken[]
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EngineTier {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  maxCc     Int?
  sortOrder Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prices          ServicePrice[]
  bookingServices BookingService[]
}

model Service {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  pricingMode ServicePricingMode @default(TIERED)
  fixedPricePence Int?
  footnotes   String?
  isActive    Boolean  @default(true)
  showInWizard        Boolean  @default(false)
  showInPricingTable  Boolean  @default(false)
  sortOrder           Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  prices          ServicePrice[]
  bookingServices BookingService[]
}

model ServicePrice {
  id           Int      @id @default(autoincrement())
  serviceId    Int
  engineTierId Int?
  amountPence  Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  service    Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  engineTier EngineTier? @relation(fields: [engineTierId], references: [id], onDelete: Cascade)

  @@unique([serviceId, engineTierId], name: "serviceId_engineTierId")
}

model Settings {
  id                            Int      @id
  companyName                   String?
  companyAddress                String?
  companyPhone                  String?
  companyRegNumber              String?
  companyWebsite                String?
  vatNumber                     String?
  vatRegistered                 Boolean  @default(false)
  vatRatePercent                Decimal  @db.Decimal(5, 2)
  timezone                      String
  defaultSlotsJson              Json
  saturdaySlotsJson             Json?
  sundaySlotsJson               Json?
  bankHolidayRegion             String
  logoUrl                       String?
  invoicePaymentNotes           String?
  bankName                      String?
  bankSortCode                  String?
  bankAccountNumber             String?
  bankIban                      String?
  bankSwift                     String?
  invoiceNumberFormat           String?
  brandPrimaryColor             String?
  invoiceItemsJson              Json?
  holdMinutes                   Int
  captchaEnabled                Boolean  @default(true)
  captchaRequireInDev           Boolean  @default(false)
  vrmLookupRateLimitPerMinute   Int?
  signupRateLimitPerHour        Int?
  bookingConfirmRateLimitPerDay Int?
  dvlaApiKey                    String?
  dvlaApiKeyEnc                 String?
  dvlaApiKeyIv                  String?
  dvlaApiKeyTag                 String?
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
}

model NotificationRecipient {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExceptionDate {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique
  reason    String?
  createdAt DateTime @default(now())
}

model ExtraSlot {
  id        Int      @id @default(autoincrement())
  date      DateTime
  time      String
  capacity  Int      @default(1)
  createdAt DateTime @default(now())

  @@unique([date, time])
}

model Booking {
  id                  Int           @id @default(autoincrement())
  userId              Int
  status              BookingStatus @default(DRAFT)
  source              BookingSource @default(ONLINE)
  slotDate            DateTime
  slotTime            String
  holdId              String?
  reference           String?       @unique
  customerName        String
  customerTitle       String?
  customerFirstName   String?
  customerLastName    String?
  customerCompany     String?
  customerEmail       String
  customerPhone       String
  customerMobile      String?
  customerLandline    String?
  customerAddressLine1 String?
  customerAddressLine2 String?
  customerAddressLine3 String?
  customerCity        String?
  customerCounty      String?
  customerPostcode    String?
  wantsSmsReminder    Boolean      @default(false)
  acceptedTermsAt     DateTime?
  vehicleRegistration String
  vehicleMake         String?
  vehicleModel        String?
  vehicleEngineSizeCc Int?
  notes               String?
  internalNotes       String?
  paymentStatus       String?
  serviceCode         String?
  engineTierCode      EngineTierCode?
  servicePricePence   Int?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  user      User             @relation(fields: [userId], references: [id])
  services  BookingService[]
  documents Document[]

  @@unique([slotDate, slotTime])
  @@index([slotDate])
  @@index([status])
  @@index([userId])
  @@index([source])
}

model BookingService {
  id             Int      @id @default(autoincrement())
  bookingId      Int
  serviceId      Int
  engineTierId   Int?
  unitPricePence Int
  createdAt      DateTime @default(now())

  booking    Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service    Service    @relation(fields: [serviceId], references: [id])
  engineTier EngineTier? @relation(fields: [engineTierId], references: [id])

  @@unique([bookingId, serviceId, engineTierId], name: "bookingId_serviceId_engineTierId")
}

model Sequence {
  id        Int         @id @default(autoincrement())
  key       SequenceKey
  year      Int
  counter   Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([key, year], name: "key_year")
}

model Document {
  id               Int            @id @default(autoincrement())
  bookingId        Int?
  userId           Int?
  type             DocumentType
  number           String         @unique
  status           DocumentStatus @default(DRAFT)
  totalAmountPence Int
  vatAmountPence   Int
  pdfUrl           String
  payload          Json?
  version          Int            @default(1)
  issuedAt         DateTime?
  dueAt            DateTime?
  paidAt           DateTime?
  paymentMethod    String?
  validUntil       DateTime?
  createdBy        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
}

model UserSession {
  id         Int      @id @default(autoincrement())
  userId     Int
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
