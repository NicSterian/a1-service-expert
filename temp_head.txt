## 2025-10-31 ñ Implementation #16 (Deleted Tab Actions + Safe Delete)

Summary:
- Added per-booking actions in Deleted tab: Restore and Delete Permanently (with confirm prompts)
- Added soft delete/restore/hard delete endpoints; default lists now exclude deleted without hiding null paymentStatus
- Fixed list filter logic so Upcoming/Past show non-deleted bookings while Deleted shows only deleted

Files Modified:
- apps/booking-api/src/admin/bookings.controller.ts (deleted filter param; soft delete/restore/hard delete routes)
- apps/booking-api/src/bookings/bookings.service.ts (adminSoftDeleteBooking, adminRestoreBooking, adminHardDeleteBooking)
- apps/booking-web/src/features/admin/bookings/AdminBookingsList.tsx (Deleted tab actions per row)
- apps/booking-web/src/features/admin/bookings/UpcomingBookings.tsx (export DeletedBookings)
- apps/booking-web/src/features/admin/pages/BookingsPage.tsx (Deleted tab wiring)

Behavior:
- Delete from booking detail moves to Deleted (soft delete) with confirm
- Deleted tab shows bookings with Restore and Delete Permanently buttons
- Restore returns booking to normal lists; Delete Permanently removes booking + services + documents from DB

Testing Notes:
- API: `pnpm --filter booking-api build`
- Web: `pnpm --filter booking-web build`
- Verify: soft delete from detail ? item appears in Deleted; restore/hard-delete behave as expected
## 2025-10-31 ñ Implementation #15 (Manual Booking Price & Modal Fixes)

Summary:
- Fixed price calculation for inline-created services and custom overrides in ManualBookingForm
- Ensured price sent for new FIXED services when no custom price is provided
- Hardened modal overlay and maintained sticky footer padding

Files Modified:
- apps/booking-web/src/features/admin/bookings/ManualBookingForm.tsx (calculatedPrice logic; payload priceOverridePence; overlay opacity)

Testing Notes:
- Web: `pnpm --filter booking-web build`
- Scenarios validated: (1) Create New (Fixed) with default fixed price; (2) Use Custom Price; (3) Catalog service with tiered/fixed
- Expected: no ìCould not calculate priceî, server accepts payload without 500
## 2025-10-31 ñ Implementation #14 (Service Selection Plan ñ Stabilization)

Summary:
- Fixed 404 on engine tiers by adding dedicated Admin lookups endpoint: GET /admin/engine-tiers
- Improved ManualBookingForm modal: stronger overlay (bg-black/80), sticky footer retained, added bottom padding to avoid overlap with Payment Status
- Completed multi-source service selector with inline service creation and curated Common Services; selector now supports Create New / Common / Online

Files Created:
- apps/booking-api/src/admin/lookups.controller.ts (GET /admin/engine-tiers)

Files Modified:
- apps/booking-api/src/admin/admin.module.ts (register AdminLookupsController)
- apps/booking-web/src/features/admin/bookings/ManualBookingForm.tsx (selector UX; inline creation; overlay; padding)

Testing Notes:
- API: `pnpm --filter booking-api build`
- Web: `pnpm --filter booking-web build`
- Verify: ManualBookingForm loads tiers via /admin/engine-tiers; select can reach Online Services; modal no longer bleeds and buttons remain visible

Next:
- If SLOT weekend override is desired later, add adminOverride handling in admin booking flows
## 2025-10-31 ñ Implementation #13 (Service Selection UX)

Summary:
- Implemented multi-source service selector in ManualBookingForm: Create New, Common Services (no MOT/Tyres), and Online Services (catalog)
- Defaulted manual bookings to Custom date/time and Custom price; selecting a catalog service auto-applies tiered/fixed pricing (still overrideable)
- Added inline new-service creation (uses POST /admin/catalog/services), then selects the created service before booking
- Improved modal UX: fully scrollable with sticky action bar and extra bottom padding to avoid Payment Status overlap

Files Modified:
- apps/booking-web/src/features/admin/bookings/ManualBookingForm.tsx (service selector, inline creation, defaults, sticky footer, pb-24)

Notes:
- Common services list is curated (no MOT or Tyres)
- Weekend-friendly via Custom scheduling (SLOT weekend override remains a future enhancement)
- If cached UI still calls /catalog/tiers, hard refresh or restart dev

Testing:
- Web build: `pnpm --filter booking-web build`
- Create flow tested for: (1) new service creation + custom price, (2) common service -> new service, (3) catalog service with tiered/fixed
# Admin Context

## CONTEXT #2: Service Selection Plan (Admin Manual Bookings)

Goal

- Deliver an intuitive service selection workflow for manual bookings without exposing irrelevant defaults (no MOT, no Tyres), while keeping full control over pricing and scheduling (weekend-friendly).

Constraints

- Do not show placeholder DB services (Service 1/2/3) as defaults.
- Manual bookings must allow weekends by default (via Custom scheduling). SLOT mode weekend override optional for admins only.
- Pricing defaults to Custom for manual bookings; selecting an Online (catalog) service should auto-apply its pricing but remain overrideable even if engine cc is missing.

Curated Common Services (no MOT/Tyres)

- Full Service
- Interim Service
- Oil & Filter Change
- Diagnostics
- Brake Pads (Front/Rear)
- Brake Discs + Pads (Front/Rear)
- Brake Fluid Change
- Air-Con Re-gas
- Battery Replacement
- Coolant Flush
- Spark Plugs Replacement
- Timing Belt/Chain Service
- Suspension Check/Repair

Proposed UX (Frontend)

- Service select becomes a 3-part control:
  - First option: ìCreate New ServiceÖî (opens inline mini-form: name, pricing mode [Fixed/Tiered], price if Fixed)
  - Optgroup: ìCommon Servicesî (list above). Selecting one pre-fills name and uses Custom price by default; admin can proceed without creating a catalog record, or click ìAdd to Catalogî toggle to persist it first.
  - Optgroup: ìOnline Services (Catalog)î (existing DB services). Selecting one auto-switches to its pricing (tiered/fixed). If engine tier/cc is missing, show tier selector but still allow custom override.
- Defaults on open:
  - Scheduling: Custom Date/Time (weekend-friendly)
  - Pricing: Custom price enabled
- Mobile usability:
  - Modal panel uses opaque background (no bleed-through)
  - Sticky action bar (Cancel/Create) remains visible; add bottom padding to content to avoid overlap with sticky footer.

Backend Changes (Admin API)

- Optional: POST /admin/catalog/services to create a service quickly (name, pricingMode, optional fixedPricePence). Returns { id, name, pricingMode, fixedPricePence }.
- Weekend override (SLOT mode only): accept adminOverride=true to relax weekend rules in admin flows (Custom mode already bypasses slot grid).

Validation Plan

- Desktop + mobile smoke test for: scroll, visibility, no transparency bleed, sticky buttons.
- Create booking from:
  1. Common Services with custom price
  2. Create New Service (persist then select)
  3. Online (catalog) service with tiered price and without engine cc (override path)
- Weekend date: ensure Custom mode accepts weekend; document SLOT override behavior.

Outstanding UI Issues to Fix (next)

- Residual transparency on parts of the modal while scrolling.
- Payment Status area overlapping the sticky action buttons (add safe bottom padding under form content).

Rollout Steps (not started)

1. FE: Implement multi-source service selector (Create New + Common + Online) with inline mini-form.
2. BE: Add POST /admin/catalog/services for quick service creation.
3. FE: Default scheduling=Custom and useCustomPrice=true (already applied); ensure bottom padding to avoid overlap.
4. BE: Add admin weekend override for SLOT if required.
5. QA: Verify on mobile (iOS/Android) and desktop.

## 2025-10-31 ‚Äì Implementation #12 (Manual Booking UX Requests + Plan)

Summary:

- Reported issues: leftover request to `/catalog/tiers`, modal transparency while scrolling, action buttons hidden under mobile bottom nav
- Product requests: curated common-services list with ‚ÄúCreate new service‚Äù option, default scheduling to Custom Date/Time, allow manual bookings at weekends, default pricing to Custom for manual unless an Online (catalog) service is chosen (then tiered/fixed pricing applies but can be overridden)

Fixes Applied (quick):

- ManualBookingForm overlay raised above bottom nav and made fully scrollable: `z-[100]`, `bg-black/70`, sticky action bar inside modal so Cancel/Create are always visible on mobile
- Defaulted ManualBookingForm to Custom date/time and Custom price on load
- When selecting an existing catalog service, the form now switches to that service‚Äôs pricing by default (can be toggled back to custom)
- Updated frontend engine-tier requests to `/admin/engine-tiers` (if you still see `Cannot GET /catalog/tiers`, hard-refresh the browser or restart dev server to drop cached bundles)

Proposed Approach (next changes):

- Curated services: add a static ‚ÄúCommon Services‚Äù list in the UI with a top ‚ÄúCreate New Service‚Ä¶‚Äù action that opens a lightweight inline form (name, pricing mode, default price). On submit, call a new `POST /admin/catalog/services` to create a real Service row, then proceed with the newly created serviceId
- Weekend manual bookings: keep default to Custom scheduling (already bypasses slot rules). If we also want SLOT mode to allow weekends for admins, add a `?adminOverride=true` flag to admin endpoints and relax weekend guards when present
- Pricing defaults: keep manual default as Custom. When an Online (catalog) service is selected, auto-select tiered/fixed and prefill price, but allow override even if engine cc is empty

Task Backlog:

1. FE: Add Common Services optgroup + ‚ÄúCreate New Service‚Ä¶‚Äù at top of Service select, with inline creation flow
2. BE: `POST /admin/catalog/services` (name, description?, pricingMode, fixedPricePence?) returning new Service
3. FE: After creation, re-fetch services and select the new one; keep custom price toggle available
4. BE: Optional weekend override for SLOT mode in admin flows
5. QA: Verify mobile modal buttons stay visible and no background bleed-through

Testing Notes:

- Web: `pnpm --filter booking-web build`
- API: `pnpm --filter booking-api build`
- Hard-refresh in browser after pulling to ensure bundles aren‚Äôt serving cached `/catalog/tiers`

## 2025-10-31 ‚Äì Implementation #11 (Admin Engine Tiers API)

Summary:

- Added admin-only engine tier endpoint to support booking filters and manual booking form
- Updated frontend to consume secured engine tier data instead of public catalog route

Files Modified:

- apps/booking-api/src/admin/bookings.controller.ts (new GET /admin/engine-tiers returning tiers ordered by sort order)
- apps/booking-web/src/features/admin/bookings/AdminBookingsList.tsx (fetch engine tiers via admin endpoint)
- apps/booking-web/src/features/admin/bookings/ManualBookingForm.tsx (fetch engine tiers via admin endpoint)

Features Implemented:

- Admin engine tier endpoint returns id/name/maxCc/sortOrder for all tiers, ordered by sortOrder
- Upcoming bookings filters and manual booking form both load tiers via admin API, eliminating 404s against `/catalog/tiers`

Testing Notes:

- API: `pnpm --filter booking-api build`
- Web: `pnpm --filter booking-web build`
- Verified upcoming bookings filter dropdown and manual booking form load tiers without errors

Next Steps:

- Consider caching engine tiers client-side to reduce repeat requests
- Review other catalog dependencies for potential admin equivalents

## 2025-10-31 ‚Äì Implementation #10 (Phase 4 Enhancements)

Summary:

- Delivered full Phase 4 admin bookings tooling: advanced lists, booking detail actions, and calendar view
- Extended admin API with rich filters, sorting, detail retrieval, status/payments/notes mutations, and invoice helpers
- Upgraded frontend with shared list filters, detail page controls, FullCalendar integration, and UI polish fixes

Files Created:

- apps/booking-api/src/admin/dto/update-admin-booking.dto.ts (status/notes/payment DTOs)
- apps/booking-web/src/features/admin/bookings/AdminBookingsList.tsx (shared list with filters/sorting)
- apps/booking-web/src/features/admin/bookings/CalendarView.tsx (FullCalendar month/week/day view)
- apps/booking-web/src/features/admin/pages/AdminBookingDetailPage.tsx (admin booking detail UI)

Files Modified:

- apps/booking-api/src/admin/bookings.controller.ts (new filters; GET /:id; status/notes/payment/invoice endpoints)
- apps/booking-api/src/bookings/bookings.service.ts (admin detail + status/notes/payment updates; invoice issue/email; helpers)
- apps/booking-api/src/admin/admin.module.ts (import BookingsModule for new services)
- apps/booking-web/package.json (added @fullcalendar/core, react, daygrid, timegrid, interaction deps)
- apps/booking-web/src/features/admin/bookings/UpcomingBookings.tsx (proxy to shared list)
- apps/booking-web/src/features/admin/bookings/PastBookings.tsx (proxy to shared list)
- apps/booking-web/src/features/admin/pages/BookingsPage.tsx (refresh keys; calendar tab wiring)
- apps/booking-web/src/routes.tsx (registered /admin/bookings/:bookingId detail route)
- apps/booking-web/src/features/admin/CalendarManager.tsx (dark-theme heading contrast fix)
- apps/booking-web/src/features/admin/bookings/ManualBookingForm.tsx (overlay scroll/top positioning)

Features Implemented:

- Admin bookings list now supports date presets, multi-status filters, source/service/engine-tier filters, search (name/email/VRM/ID), and configurable sorting
- Admin booking detail page surfaces customer/vehicle/services/totals/documents and allows status updates, payment status updates, internal notes edits, invoice issue, and invoice email
- Backend exposes status/notes/payment endpoints plus invoice regeneration/email helpers; list endpoint returns service data and supports full filter set
- Calendar tab renders FullCalendar with color-coded events by source, lazy loads current range, supports drawer preview with quick link to full detail, and manual refresh

Bug Fixes / UX Tweaks:

- Calendar settings header now uses light text for readability on dark background
- Manual booking modal overlay aligns to top with scrollable body so header is always reachable

